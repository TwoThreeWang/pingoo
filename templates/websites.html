{{template "base" .}}

{{define "head"}}
<style>
    /* å›¾è¡¨åŒºåŸŸ */
    .chart-section {
        border: 1px solid var(--border-primary);
        padding: 1rem;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--bg-primary-text);
    }

    .chart-container {
        height: 300px;
        position: relative;
    }
    .chart {
        display: flex;
        align-items: end;
        height: 95%;
        gap: 0.4em;
        border-radius: 8px;
        position: relative;
        background: linear-gradient(to bottom, rgba(204, 120, 92, 0.1), transparent);
        padding-top: 30px
    }

    .bar {
        flex: 1;
        background: var(--primary-color);
        position: relative;
        min-height: 2px;
        border-radius: 2px 2px 0 0;
        opacity: 0.7;
    }
    .bar:hover {
        opacity: 1;
    }

    .bar-value {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: #888;
        text-align: center;
        width: 100%;
    }

    .x-axis {
        display: flex;
        gap: 0.4em;
    }

    .x-label {
        flex: 1;
        font-size: 12px;
        color: var(--bg-secondary-text);
        text-align: center;
    }

    /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        padding: 1rem;
        min-width: 0;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.1rem 0;
        border-bottom: 1px solid var(--border-primary);
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-item-label {
        font-size: 0.875rem;
        color: var(--bg-primary-text);
        max-width: 70%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .stat-item-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .date-nav-btn {
        padding: 0.5rem;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .chart,.x-axis {
            gap: 1px;
        }
        .x-axis{
            margin-top: -8px;
            font-size: 0.5em;
        }

        .x-label:nth-child(2n) {
            opacity: 0;
        }

        .bar-value {
            font-size: 9px;
        }
        .chart-container {
            height: 200px;
        }
    }
    @media (max-width: 480px) {
        .chart,.x-axis {
            gap: 0;
        }
        .x-label {
            opacity: 0;
        }
        .x-label:nth-child(3n+1) {
            opacity: 1;
        }
    }
</style>
{{end}}

{{define "content"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">é¦–é¡µ</a></li>
        <li class="breadcrumb-item"><a href="/dashboard">ä»ªè¡¨ç›˜</a></li>
        <li class="breadcrumb-item active" aria-current="page">ç½‘ç«™æ¦‚è§ˆ</li>
    </ol>
</nav>
<div class="dashboard-header">
    <h2>ç½‘ç«™æ¦‚è§ˆ</h2>
    <p class="dashboard-subtitle">æŸ¥çœ‹ç½‘ç«™æµé‡å’Œç»Ÿè®¡æ•°æ®æ˜ç»†</p>
</div>
<div class="content">
    <!-- ç½‘ç«™æ¦‚è§ˆ -->
    <div class="site-item">
        <div class="site-header">
            <h3 class="site-name">â€£ {{.Site.Name}}</h3>
            <a href="{{.Site.Domain}}" target="_balnk" class="site-url">{{.Site.Domain}}</a>
            <span>
                <input type="date" class="date-selector" id="date-selector" value="{{.Today}}" onchange="dateChange()"
                    style="width:auto;">
                <button class="date-nav-btn" id="prev-day" onclick="changeDay(-1)">â—„</button>
                <button class="date-nav-btn" id="next-day" onclick="changeDay(1)">â–º</button>
            </span>
        </div>
        <div class="site-metrics">
            <div class="metric">
                <div class="metric-label">æµè§ˆé‡PV</div>
                <div class="metric-value" id="pv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">è®¿å®¢æ•°UV</div>
                <div class="metric-value" id="uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">ç‹¬ç«‹IPæ•°</div>
                <div class="metric-value" id="ip">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">è·³å‡ºç‡</div>
                <div class="metric-value" id="bounce_rate">0%</div>
            </div>
            <div class="metric">
                <div class="metric-label">å¹³å‡è®¿é—®æ—¶é•¿</div>
                <div class="metric-value" id="avg_duration">0s</div>
            </div>
            <div class="metric">
                <div class="metric-label">äº‹ä»¶æ•°é‡</div>
                <div class="metric-value" id="event_count">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬å‘¨è®¿å®¢UV</div>
                <div class="metric-value" id="week_uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬å‘¨æµè§ˆé‡PV</div>
                <div class="metric-value" id="week_pv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬æœˆè®¿å®¢UV</div>
                <div class="metric-value" id="month_uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬æœˆæµè§ˆé‡PV</div>
                <div class="metric-value" id="month_pv">0</div>
            </div>
        </div>
    </div>

    <!-- æµé‡å›¾è¡¨ -->
    <div class="chart-section">
        <div class="chart-header">
            <span class="chart-title">å½“æ—¥æ—¶æ®µæµé‡åˆ†å¸ƒ</span>
            <span>24å°æ—¶æ•°æ®</span>
        </div>
        <div class="chart-container">
            <div class="chart" id="hourly-traffic-chart">
                <center><span class="loading"></span>æ­£åœ¨åŠ è½½æ—¶æ®µæµé‡æ•°æ®...</center>
            </div>
            <div class="x-axis">
                <span class="x-label">00</span>
                <span class="x-label">01</span>
                <span class="x-label">02</span>
                <span class="x-label">03</span>
                <span class="x-label">04</span>
                <span class="x-label">05</span>
                <span class="x-label">06</span>
                <span class="x-label">07</span>
                <span class="x-label">08</span>
                <span class="x-label">09</span>
                <span class="x-label">10</span>
                <span class="x-label">11</span>
                <span class="x-label">12</span>
                <span class="x-label">13</span>
                <span class="x-label">14</span>
                <span class="x-label">15</span>
                <span class="x-label">16</span>
                <span class="x-label">17</span>
                <span class="x-label">18</span>
                <span class="x-label">19</span>
                <span class="x-label">20</span>
                <span class="x-label">21</span>
                <span class="x-label">22</span>
                <span class="x-label">23</span>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ -->
    <div class="stats-grid">
        <!-- è®¿é—®ç½‘é¡µTop10 -->
        <div class="stat-card">
            <b>ğŸ“Š è®¿é—®ç½‘é¡µTop10</b>
            <ol class="stat-list" id="url-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- æ¥æºTop10 -->
        <div class="stat-card">
            <b>ğŸ”— æ¥æºTop10</b>
            <ol class="stat-list" id="referrer-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- æ“ä½œç³»ç»ŸTop10 -->
        <div class="stat-card">
            <b>ğŸ’» æ“ä½œç³»ç»ŸTop10</b>
            <ol class="stat-list" id="os-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- æµè§ˆå™¨ç»Ÿè®¡ -->
        <div class="stat-card">
            <b>ğŸŒ æµè§ˆå™¨</b>
            <ol class="stat-list" id="browser-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- è®¿é—®åœ°åŒºåˆ†å¸ƒ -->
        <div class="stat-card">
            <b>ğŸŒ è®¿é—®åœ°åŒºåˆ†å¸ƒ</b>
            <ol class="stat-list" id="country-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- è¿è¥å•†åˆ†å¸ƒ -->
        <div class="stat-card">
            <b>ğŸ“¶ ç½‘ç»œåˆ†å¸ƒ</b>
            <ol class="stat-list" id="isp-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- å±å¹•å°ºå¯¸ -->
        <div class="stat-card">
            <b>ğŸ–¥ï¸ å±å¹•å°ºå¯¸</b>
            <ol class="stat-list" id="screen-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- äº‹ä»¶ -->
        <div class="stat-card">
            <b>ğŸ¯ äº‹ä»¶ç»Ÿè®¡</b>
            <ol class="stat-list" id="event_type-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>

        <!-- è®¾å¤‡ç±»å‹åˆ†å¸ƒ -->
        <div class="stat-card">
            <b>ğŸ“± è®¾å¤‡ç±»å‹åˆ†å¸ƒ</b>
            <ol class="stat-list" id="device-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>


        <!-- çˆ¬è™« -->
        <div class="stat-card">
            <b>ğŸ•·ï¸ çˆ¬è™«ç»Ÿè®¡</b>
            <ol class="stat-list" id="bot-list">
                <center><span class="loading"></span>åŠ è½½ä¸­...</center>
            </ol>
        </div>
    </div>
</div>
{{end}}

{{define "extra_js"}}
<script>
    const siteId = "{{.Site.ID}}";
    const dateInput = document.getElementById('date-selector');
    // è·å–ç½‘ç«™summaryä¿¡æ¯å¹¶å¡«å……åˆ°site-metricså®¹å™¨
    async function loadSiteMetrics() {
        const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

        // è°ƒç”¨APIè·å–summary
        try {
            const statsResponse = await sendRequest('GET', `/api/events/${siteId}/summary?date=${date}`);

            let stats = {
                pv: 0,
                uv: 0,
                ip_count: 0,
                event_count: 0,
                bounce_rate: 0,
                avg_duration: 0,
                week_uv: 0,
                week_pv: 0,
                month_uv: 0,
                month_pv: 0,
                hourly_stats: {},
            };

            if (statsResponse.ok) {
                const statsResult = await statsResponse.json();
                if (statsResult.code == 0) {
                    stats = statsResult.data;
                } else {
                    showMessage(statsResult.data.msg, 'error');
                }
            } else {
                showMessage('ç«™ç‚¹æ¦‚è§ˆæ•°æ®è¯·æ±‚å¤±è´¥', 'error');
            }
            // åˆ›å»ºç½‘ç«™é¡¹
            createSiteElement(stats);
        } catch (error) {
            console.error(`è·å–ç½‘ç«™ {{.Site.Name}} ç»Ÿè®¡æ•°æ®å¤±è´¥:`, error);
            showMessage(`è·å–ç½‘ç«™ {{.Site.Name}} ç»Ÿè®¡æ•°æ®å¤±è´¥`, "error");
        }
    }

    // æ¸²æŸ“ç½‘ç«™æŒ‡æ ‡æ•°æ®
    function createSiteElement(stats) {
        // æ ¼å¼åŒ–å¹³å‡è®¿é—®æ—¶é•¿
        const formatDuration = (seconds) => {
            if (!seconds || seconds < 60) return `${seconds || 0}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m${remainingSeconds}s`;
        };
        document.getElementById('pv').innerHTML = stats.pv || 0;
        document.getElementById('uv').innerHTML = stats.uv || 0;
        document.getElementById('ip').innerHTML = stats.ip_count || 0;
        document.getElementById('event_count').innerHTML = stats.event_count || 0;
        document.getElementById('bounce_rate').innerHTML = (stats.bounce_rate || 0).toFixed(1)+"%";
        document.getElementById('avg_duration').innerHTML = formatDuration(Math.floor(stats.avg_duration || 0));
        document.getElementById('week_uv').innerHTML = stats.week_uv || 0;
        document.getElementById('week_pv').innerHTML = stats.week_pv || 0;
        document.getElementById('month_uv').innerHTML = stats.month_uv || 0;
        document.getElementById('month_pv').innerHTML = stats.month_pv || 0;
        // æ›´æ–°å°æ—¶æµé‡åˆ†å¸ƒ
        const hourlyContainer = document.getElementById('hourly-traffic-chart');
        if (stats.hourly_stats && stats.hourly_stats.length > 0) {
            if (hourlyContainer) {
                // è®¡ç®—æœ€å¤§å€¼ç”¨äºæ¯”ä¾‹è®¡ç®—
                const maxValue = Math.max(...stats.hourly_stats.map(h => h.count));

                let hourlyHtml = '';

                // ç”Ÿæˆ24å°æ—¶çš„å›¾è¡¨æ¡ï¼Œç¡®ä¿æ¯ä¸ªå°æ—¶éƒ½æœ‰æ•°æ®
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = stats.hourly_stats.find(h => h.hour === hour);
                    const count = hourData ? hourData.count : 0;
                    const heightPercentage = maxValue > 0 ? (count / maxValue) * 100 : 0;
                    hourlyHtml += `
                    <div class="bar" style="height: ${Math.max(heightPercentage, 1)}%">
                        <div class="bar-value">${count}</div>
                    </div>
                `;
                }
                hourlyContainer.innerHTML = hourlyHtml;
            }
        } else {
            hourlyContainer.innerHTML = '<p>æœªè·å–åˆ°åˆ†æ—¶æµé‡æ•°æ®...</p>';
        }
    }

    // è·å–è¯¦ç»†ç»Ÿè®¡æ•°æ®å¹¶å±•ç¤º
    async function loadSiteStats() {
        const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        stat_types = ['url', 'referrer', 'os', 'device', 'country', 'isp', 'event_type', 'bot', 'screen', 'browser']
        for (let i = 0; i < stat_types.length; i++) {
            try {
                const response = await sendRequest('GET', `/api/events/${siteId}/stats?date=${date}&stat_type=${stat_types[i]}`);
                if (!response.ok) {
                    throw new Error(stat_types[i] + 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
                }

                const result = await response.json();
                if (result.code === 0 && result.data) {
                    renderStatList(stat_types[i], result.data.list);
                } else {
                    throw new Error(result.msg || 'è·å–æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–è¯¦ç»†ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                showMessage('è·å–è¯¦ç»†ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'error');
            }
        }

    }

    // æ¸²æŸ“ç»Ÿè®¡åˆ—è¡¨çš„é€šç”¨å‡½æ•°
    function renderStatList(containerId, data) {
        const container = document.getElementById(`${containerId}-list`);
        if (!container) return;

        if (data && data.length > 0) {
            let html = '';
            data.forEach((item, index) => {
                var label = item['key'];
                if (label == '') {
                    label = '-'
                }
                html += `
                <li class="stat-item">
                    <span class="stat-item-label">${label}</span>
                    <span class="stat-item-value">${item['count']}</span>
                </li>
            `;
            });
            html += `<center><br><a href="/detail/${siteId}?type=${containerId}">æŸ¥çœ‹æ›´å¤š</a><center>`
            container.innerHTML = html;
        } else {
            container.innerHTML = `<center>æš‚æ— æ•°æ®</center>`;
        }
    }

    // ç›‘å¬æ—¥æœŸé€‰æ‹©å™¨å˜åŒ–
    function dateChange() {
        loadSiteMetrics();
        loadSiteStats();
    }

    // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°summaryå’Œè¯¦ç»†stats
    setInterval(() => {
        loadSiteMetrics();
        loadSiteStats();
    }, 60000);
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŠ è½½
        loadSiteMetrics();
        loadSiteStats();
    });


    function changeDay(offset) {
        const dateSelector = document.getElementById('date-selector');
        const currentDate = new Date(dateSelector.value);
        currentDate.setDate(currentDate.getDate() + offset);
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const newDate = `${year}-${month}-${day}`;
        dateSelector.value = newDate;
        dateChange();
    }
</script>
{{end}}