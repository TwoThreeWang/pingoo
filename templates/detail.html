{{template "base" .}}

{{define "content"}}
<style>
    /* 统计卡片网格 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.1rem 0;
        border-bottom: 1px solid var(--border-primary);
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-item-label {
        font-size: 0.875rem;
        color: var(--bg-primary-text);
        max-width: 70%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .stat-item-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .date-nav-btn {
        padding: 0.5rem;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
<div class="dashboard-container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item"><a href="/dashboard">仪表盘</a></li>
            <li class="breadcrumb-item"><a href="/websites/{{.Site.ID}}">网站概览</a></li>
            <li class="breadcrumb-item active" aria-current="page">事件详情</li>
        </ol>
    </nav>

    <div class="dashboard-header">
        <h2>事件详情分析</h2>
        <p class="dashboard-subtitle">查看指定类型的事件统计数据和详情</p>
    </div>

    <!-- 网站概览 -->
    <div class="site-item">
        <div class="site-header">
            <h3 class="site-name">‣ {{.Site.Name}}</h3>
            <a href="{{.Site.Domain}}" target="_balnk" class="site-url">{{.Site.Domain}}</a>
            <span>
                <input type="date" class="date-selector" id="date-selector" value="{{.Today}}" onchange="dateChange()"
                    style="width:auto;">
                <button class="date-nav-btn" id="prev-day" onclick="changeDay(-1)">◄</button>
                <button class="date-nav-btn" id="next-day" onclick="changeDay(1)">►</button>
            </span>
        </div>
        <div class="site-metrics">
            <div class="metric">
                <div class="metric-label">浏览量PV</div>
                <div class="metric-value" id="pv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">访客数UV</div>
                <div class="metric-value" id="uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">独立IP数</div>
                <div class="metric-value" id="ip">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">跳出率</div>
                <div class="metric-value" id="bounce_rate">0%</div>
            </div>
            <div class="metric">
                <div class="metric-label">平均访问时长</div>
                <div class="metric-value" id="avg_duration">0s</div>
            </div>
            <div class="metric">
                <div class="metric-label">事件数量</div>
                <div class="metric-value" id="event_count">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">本周访客UV</div>
                <div class="metric-value" id="week_uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">本周浏览量PV</div>
                <div class="metric-value" id="week_pv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">本月访客UV</div>
                <div class="metric-value" id="month_uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">本月浏览量PV</div>
                <div class="metric-value" id="month_pv">0</div>
            </div>
        </div>
    </div>

    <div class="side-container">
        <!-- 左侧事件类型选择 -->
        <div class="sidebar-container">
            <h3>事件类型</h3>
            <div class="sidebar">
            <a href="javascript:void(0)" data-type="url" data-event="page_view" onclick="switchEventType(this)">📊 受访页面</a>
            <a href="javascript:void(0)" data-type="referrer" data-event="page_view" onclick="switchEventType(this)">🔗 访问来源</a>
            <a href="javascript:void(0)" data-type="os" data-event="page_view" onclick="switchEventType(this)">💻 操作系统</a>
            <a href="javascript:void(0)" data-type="device" data-event="page_view" onclick="switchEventType(this)">📱 设备类型</a>
            <a href="javascript:void(0)" data-type="country" data-event="page_view" onclick="switchEventType(this)">🌍 国家地区</a>
            <a href="javascript:void(0)" data-type="isp" data-event="page_view" onclick="switchEventType(this)">📶 网络分布</a>
            <a href="javascript:void(0)" data-type="screen" data-event="page_view" onclick="switchEventType(this)">🖥️ 屏幕尺寸</a>
            <a href="javascript:void(0)" data-type="bot" data-event="page_view" onclick="switchEventType(this)">🕷️ 网络爬虫</a>
            <a href="javascript:void(0)" data-type="browser" data-event="page_view" onclick="switchEventType(this)">🌐 浏览器</a>
            <a href="javascript:void(0)" data-type="event_type" data-event="custom" onclick="switchEventType(this)">🎯 互动事件</a>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="content">
            <!-- 事件列表 -->
            <div class="stat-card">
                <h3 id="current-event-title">📊 受访页面统计</h3>
                <ol class="stat-list" id="event-list">
                    <center><span class="loading"></span>加载中...</center>
                </ol>
                <!-- 分页控件 -->
                <div class="pagination" id="pagination">
                    <button class="pagination-btn" id="prev-page" disabled>◄</button>
                    <button class="pagination-current" id="current-page">1</button>
                    <button class="pagination-btn" id="next-page" disabled>►</button>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "extra_js"}}
<script>
    const siteId = "{{.Site.ID}}";
    const dateInput = document.getElementById('date-selector');
    let currentPage = 1;
    let totalPages = 0;
    var currentStatType = 'url';
    let currentEventType = 'page_view';

    // 获取网站summary信息并填充到site-metrics容器
    async function loadSiteMetrics() {
        const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        // 调用API获取summary
        try {
            const statsResponse = await sendRequest('GET', `/api/events/${siteId}/summary?date=${date}`);
            let stats = {
                pv: 0,
                uv: 0,
                ip_count: 0,
                event_count: 0,
                bounce_rate: 0,
                avg_duration: 0,
                week_uv: 0,
                week_pv: 0,
                month_uv: 0,
                month_pv: 0,
                hourly_stats: {},
            };
            if (statsResponse.ok) {
                const statsResult = await statsResponse.json();
                if (statsResult.code == 0) {
                    stats = statsResult.data;
                } else {
                    showMessage(statsResult.data.msg, 'error');
                }
            } else {
                showMessage('站点概览数据请求失败', 'error');
            }
            // 创建网站项
            createSiteElement(stats);
        } catch (error) {
            console.error(`获取网站 {{.Site.Name}} 统计数据失败:`, error);
            showMessage(`获取网站 {{.Site.Name}} 统计数据失败`, "error");
        }
    }

    // 渲染网站指标数据
    function createSiteElement(stats) {
        // 格式化平均访问时长
        const formatDuration = (seconds) => {
            if (!seconds || seconds < 60) return `${seconds || 0}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m${remainingSeconds}s`;
        };
        document.getElementById('pv').innerHTML = stats.pv || 0;
        document.getElementById('uv').innerHTML = stats.uv || 0;
        document.getElementById('ip').innerHTML = stats.ip_count || 0;
        document.getElementById('event_count').innerHTML = stats.event_count || 0;
        document.getElementById('bounce_rate').innerHTML = (stats.bounce_rate || 0).toFixed(1)+"%";
        document.getElementById('avg_duration').innerHTML = formatDuration(Math.floor(stats.avg_duration || 0));
        document.getElementById('week_uv').innerHTML = stats.week_uv || 0;
        document.getElementById('week_pv').innerHTML = stats.week_pv || 0;
        document.getElementById('month_uv').innerHTML = stats.month_uv || 0;
        document.getElementById('month_pv').innerHTML = stats.month_pv || 0;
    }

    // 加载事件统计数据
    async function loadEventStats() {
        try {
            const eventList = document.getElementById('event-list');
            if (!eventList) return;
            const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

            // 构建API URL
            const apiUrl = `/api/events/${siteId}/stats?` +
                `date=${date}&` +
                `page=${currentPage}&` +
                `stat_type=${currentStatType}&` +
                `event_type=${currentEventType}`;

            const response = await sendRequest('GET', apiUrl);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            if (result.code !== 0) {
                throw new Error(result.msg || '获取统计数据失败');
            }

            const data = result.data;

            // 更新事件列表
            renderEventList(data.list);

            // 更新分页信息
            updatePagination(data.total, data.page_size);

        } catch (error) {
            console.error('加载事件统计数据失败:', error);
            showMessage('加载事件统计数据失败: ' + error.message, 'error');

            const eventList = document.getElementById('event-list');
            if (eventList) {
                eventList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--bg-secondary-text);">
                        <h3>加载失败</h3>
                        <p>无法加载事件数据，${error.message}</p>
                        <button onclick="loadEventStats()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: var(--primary-text); border: none; border-radius: 4px; cursor: pointer;">
                            重新加载
                        </button>
                    </div>
                `;
            }
        }
    }

    // 渲染事件列表
    function renderEventList(events) {
        const eventList = document.getElementById('event-list');
        if (!events || events.length === 0) {
            eventList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--bg-secondary-text);">
                    <h3>暂无数据</h3>
                    <p>当前筛选条件下没有找到事件数据</p>
                </div>
            `;
            return;
        }

        let html = '';
        events.forEach((event, index) => {
            html += `
                <li class="stat-item">
                    <span class="stat-item-label">${event.key || '未知'}</span>
                    <span class="stat-item-value">${event.count}</span>
                </li>
            `;
        });

        eventList.innerHTML = html;
    }

    // 更新分页信息
    function updatePagination(total, pageSize) {
        totalPages = Math.ceil(total / pageSize);

        const paginationInfo = document.getElementById('pagination-info');
        const currentPageSpan = document.getElementById('current-page');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');

        if (paginationInfo) {
            paginationInfo.textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
        }
        if (currentPageSpan) {
            currentPageSpan.textContent = currentPage;
        }
        if (prevBtn) {
            prevBtn.disabled = currentPage <= 1;
        }
        if (nextBtn) {
            nextBtn.disabled = currentPage >= totalPages;
        }
    }

    // 切换事件类型
    function switchEventType(el) {
        // 获取目标元素
        const target = el.target || el;
        currentStatType = target.getAttribute('data-type');
        currentEventType = target.getAttribute('data-event');
        const eventName = target.textContent;
        currentPage = 1;
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        target.classList.add('active');
        // 更新标题
        const title = document.getElementById('current-event-title');
        if (title) {
            title.textContent = eventName + '统计';
        }
        // 重新加载数据
        loadEventStats();
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function () {
        // 绑定分页按钮
        document.getElementById('prev-page')?.addEventListener('click', function () {
            if (currentPage > 1) {
                currentPage--;
                loadEventStats();
            }
        });

        document.getElementById('next-page')?.addEventListener('click', function () {
            if (currentPage < totalPages) {
                currentPage++;
                loadEventStats();
            }
        });
        // 初始化数据
        loadSiteMetrics();
        currentStatType = getUrlParam('type') || 'url';
        const currentTypeLink = document.querySelector(`a[data-type="${currentStatType}"]`);
        if (currentTypeLink) {
            switchEventType(currentTypeLink);
        }else{
            loadEventStats();
        }
    });
    // 监听日期选择器变化
    function dateChange() {
        loadSiteMetrics();
        loadEventStats();
    }
    function changeDay(offset) {
        const dateSelector = document.getElementById('date-selector');
        const currentDate = new Date(dateSelector.value);
        currentDate.setDate(currentDate.getDate() + offset);
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const newDate = `${year}-${month}-${day}`;
        dateSelector.value = newDate;
        dateChange();
    }
</script>
{{end}}