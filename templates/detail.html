{{template "base" .}}

{{define "content"}}
<div class="dashboard-container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">é¦–é¡µ</a></li>
            <li class="breadcrumb-item"><a href="/dashboard">ä»ªè¡¨ç›˜</a></li>
            <li class="breadcrumb-item active" aria-current="page">äº‹ä»¶è¯¦æƒ…</li>
        </ol>
    </nav>

    <div class="dashboard-header">
        <h2>äº‹ä»¶è¯¦æƒ…åˆ†æ</h2>
        <p class="dashboard-subtitle">æŸ¥çœ‹æŒ‡å®šç±»å‹çš„äº‹ä»¶ç»Ÿè®¡æ•°æ®å’Œè¯¦æƒ…</p>
    </div>

    <!-- ç½‘ç«™æ¦‚è§ˆ -->
    <div class="site-item">
        <div class="site-header">
            <h3 class="site-name">â€£ {{.Site.Name}}</h3>
            <a href="{{.Site.Domain}}" target="_balnk" class="site-url">{{.Site.Domain}}</a>
            <span>
                <input type="date" class="date-selector" id="date-selector" value="{{.Today}}" onchange="dateChange()"
                    style="width:auto;">
                <button class="date-nav-btn" id="prev-day" onclick="changeDay(-1)">â—„</button>
                <button class="date-nav-btn" id="next-day" onclick="changeDay(1)">â–º</button>
            </span>
        </div>
        <div class="site-metrics">
            <div class="metric">
                <div class="metric-label">æµè§ˆé‡</div>
                <div class="metric-value" id="pv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">è®¿é—®æ¬¡æ•°</div>
                <div class="metric-value" id="uv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">è®¿å®¢</div>
                <div class="metric-value" id="ip">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">è·³å‡ºç‡</div>
                <div class="metric-value" id="bounce_rate">0%</div>
            </div>
            <div class="metric">
                <div class="metric-label">å¹³å‡è®¿é—®æ—¶é•¿</div>
                <div class="metric-value" id="avg_duration">0s</div>
            </div>
            <div class="metric">
                <div class="metric-label">äº‹ä»¶æ•°é‡</div>
                <div class="metric-value" id="event_count">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬å‘¨è®¿å®¢</div>
                <div class="metric-value" id="week_ip">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬å‘¨æµè§ˆé‡</div>
                <div class="metric-value" id="week_pv">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬æœˆè®¿å®¢</div>
                <div class="metric-value" id="month_ip">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æœ¬æœˆæµè§ˆé‡</div>
                <div class="metric-value" id="month_pv">0</div>
            </div>
        </div>
    </div>

    <div class="detail-container">
        <!-- å·¦ä¾§äº‹ä»¶ç±»å‹é€‰æ‹© -->
        <div class="event-sidebar">
            <h3>äº‹ä»¶ç±»å‹</h3>
            <div class="event-type-list">
                <button class="event-type-btn active" data-type="url" data-event="page_view">
                    <span class="event-icon">ğŸ“Š</span>
                    <span class="event-name">é¡µé¢æµè§ˆé‡</span>
                </button>
                <button class="event-type-btn" data-type="url" data-event="click">
                    <span class="event-icon">ğŸ–±ï¸</span>
                    <span class="event-name">ç‚¹å‡»äº‹ä»¶</span>
                </button>
                <button class="event-type-btn" data-type="url" data-event="scroll">
                    <span class="event-icon">ğŸ“œ</span>
                    <span class="event-name">æ»šåŠ¨äº‹ä»¶</span>
                </button>
                <button class="event-type-btn" data-type="url" data-event="form_submit">
                    <span class="event-icon">ğŸ“</span>
                    <span class="event-name">è¡¨å•æäº¤</span>
                </button>
                <button class="event-type-btn" data-type="browser" data-event="page_view">
                    <span class="event-icon">ğŸŒ</span>
                    <span class="event-name">æµè§ˆå™¨ç»Ÿè®¡</span>
                </button>
                <button class="event-type-btn" data-type="country" data-event="page_view">
                    <span class="event-icon">ğŸŒ</span>
                    <span class="event-name">å›½å®¶åœ°åŒº</span>
                </button>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <div class="event-content">
            <!-- äº‹ä»¶åˆ—è¡¨ -->
            <div class="stat-card">
                <h3>é¡µé¢æµè§ˆé‡ç»Ÿè®¡</h3>
                <ol class="stat-list" id="event-list">
                    <center><span class="loading"></span>åŠ è½½ä¸­...</center>
                </ol>
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div class="pagination" id="pagination">
                    <button class="pagination-btn" id="prev-page" disabled>ä¸Šä¸€é¡µ</button>
                    <span class="pagination-current" id="current-page">1</span>
                    <button class="pagination-btn" id="next-page" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "extra_js"}}
<script>
    const siteId = "{{.Site.ID}}";
    const dateInput = document.getElementById('date-selector');
    let currentPage = 1;
    let totalPages = 0;
    let currentStatType = 'url';
    let currentEventType = 'page_view';

    // è·å–ç½‘ç«™summaryä¿¡æ¯å¹¶å¡«å……åˆ°site-metricså®¹å™¨
    async function loadSiteMetrics() {
        const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        // è°ƒç”¨APIè·å–summary
        try {
            const statsResponse = await sendRequest('GET', `/api/events/${siteId}/summary?date=${date}`);
            let stats = {
                pv: 0,
                uv: 0,
                ip_count: 0,
                event_count: 0,
                bounce_rate: 0,
                avg_duration: 0,
                week_ip: 0,
                week_pv: 0,
                month_ip: 0,
                month_pv: 0,
                hourly_stats: {},
            };
            if (statsResponse.ok) {
                const statsResult = await statsResponse.json();
                if (statsResult.code == 0) {
                    stats = statsResult.data;
                } else {
                    showMessage(statsResult.data.msg, 'error');
                }
            } else {
                showMessage('ç«™ç‚¹æ¦‚è§ˆæ•°æ®è¯·æ±‚å¤±è´¥', 'error');
            }
            // åˆ›å»ºç½‘ç«™é¡¹
            createSiteElement(stats);
        } catch (error) {
            console.error(`è·å–ç½‘ç«™ {{.Site.Name}} ç»Ÿè®¡æ•°æ®å¤±è´¥:`, error);
            showMessage(`è·å–ç½‘ç«™ {{.Site.Name}} ç»Ÿè®¡æ•°æ®å¤±è´¥`, "error");
        }
    }

    // æ¸²æŸ“ç½‘ç«™æŒ‡æ ‡æ•°æ®
    function createSiteElement(stats) {
        // æ ¼å¼åŒ–å¹³å‡è®¿é—®æ—¶é•¿
        const formatDuration = (seconds) => {
            if (!seconds || seconds < 60) return `${seconds || 0}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m${remainingSeconds}s`;
        };
        document.getElementById('pv').innerHTML = stats.pv || 0;
        document.getElementById('uv').innerHTML = stats.uv || 0;
        document.getElementById('ip').innerHTML = stats.ip_count || 0;
        document.getElementById('event_count').innerHTML = stats.event_count || 0;
        document.getElementById('bounce_rate').innerHTML = (stats.bounce_rate || 0).toFixed(1);
        document.getElementById('avg_duration').innerHTML = formatDuration(Math.floor(stats.avg_duration || 0));
        document.getElementById('week_ip').innerHTML = stats.week_ip || 0;
        document.getElementById('week_pv').innerHTML = stats.week_pv || 0;
        document.getElementById('month_ip').innerHTML = stats.month_ip || 0;
        document.getElementById('month_pv').innerHTML = stats.month_pv || 0;
    }


    // åŠ è½½äº‹ä»¶ç»Ÿè®¡æ•°æ®
    async function loadEventStats() {
        try {
            const eventList = document.getElementById('event-list');
            if (!eventList) return;
            const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

            // æ„å»ºAPI URL
            const apiUrl = `/api/events/1/stats?` +
                `date=${date}&` +
                `page=${currentPage}&` +
                `stat_type=${currentStatType}&` +
                `event_type=${currentEventType}`;

            const response = await sendRequest('GET', apiUrl);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            if (result.code !== 0) {
                throw new Error(result.msg || 'è·å–äº‹ä»¶ç»Ÿè®¡æ•°æ®å¤±è´¥');
            }

            const data = result.data;

            // æ›´æ–°äº‹ä»¶åˆ—è¡¨
            renderEventList(data.list);

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePagination(data.total, data.page_size);

        } catch (error) {
            console.error('åŠ è½½äº‹ä»¶ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            showMessage('åŠ è½½äº‹ä»¶ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message, 'error');

            const eventList = document.getElementById('event-list');
            if (eventList) {
                eventList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--bg-secondary-text);">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•åŠ è½½äº‹ä»¶æ•°æ®ï¼Œ${error.message}</p>
                        <button onclick="loadEventStats()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: var(--primary-text); border: none; border-radius: 4px; cursor: pointer;">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
            }
        }
    }

    // æ¸²æŸ“äº‹ä»¶åˆ—è¡¨
    function renderEventList(events) {
        const eventList = document.getElementById('event-list');
        if (!events || events.length === 0) {
            eventList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--bg-secondary-text);">
                    <h3>æš‚æ— æ•°æ®</h3>
                    <p>å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°äº‹ä»¶æ•°æ®</p>
                </div>
            `;
            return;
        }

        let html = '';
        events.forEach((event, index) => {
            html += `
                <li class="stat-item">
                    <div>
                        <div class="event-rank">${index + 1}</div>
                        <span class="stat-item-label">${event.key || 'æœªçŸ¥'}</span>
                    </div>
                    <span class="stat-item-value">${event.count}</span>
                </li>
            `;
        });

        eventList.innerHTML = html;
    }

    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    function updatePagination(total, pageSize) {
        totalPages = Math.ceil(total / pageSize);

        const paginationInfo = document.getElementById('pagination-info');
        const currentPageSpan = document.getElementById('current-page');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');

        if (paginationInfo) {
            paginationInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
        }
        if (currentPageSpan) {
            currentPageSpan.textContent = currentPage;
        }
        if (prevBtn) {
            prevBtn.disabled = currentPage <= 1;
        }
        if (nextBtn) {
            nextBtn.disabled = currentPage >= totalPages;
        }
    }

    // åˆ‡æ¢äº‹ä»¶ç±»å‹
    function switchEventType(statType, eventType, eventName) {
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.event-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // æ›´æ–°å½“å‰ç±»å‹
        currentStatType = statType;
        currentEventType = eventType;
        currentPage = 1;

        // æ›´æ–°æ ‡é¢˜
        const title = document.getElementById('current-event-title');
        if (title) {
            title.textContent = eventName + 'ç»Ÿè®¡';
        }

        // é‡æ–°åŠ è½½æ•°æ®
        loadEventStats();
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
        // ç»‘å®šäº‹ä»¶ç±»å‹åˆ‡æ¢
        document.querySelectorAll('.event-type-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const statType = this.getAttribute('data-type');
                const eventType = this.getAttribute('data-event');
                const eventName = this.querySelector('.event-name').textContent;
                switchEventType(statType, eventType, eventName);
            });
        });

        // ç»‘å®šåˆ†é¡µæŒ‰é’®
        document.getElementById('prev-page')?.addEventListener('click', function () {
            if (currentPage > 1) {
                currentPage--;
                loadEventStats();
            }
        });

        document.getElementById('next-page')?.addEventListener('click', function () {
            if (currentPage < totalPages) {
                currentPage++;
                loadEventStats();
            }
        });

        // åˆå§‹åŒ–æ•°æ®
        loadSiteMetrics();
        loadEventStats();
    });
</script>

<style>
    .detail-container {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
    }

    .event-sidebar {
        flex: 0 0 250px;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1.5rem;
        height: fit-content;
    }

    .event-sidebar h3 {
        margin: 0 0 1rem 0;
        color: var(--bg-primary-text);
        font-size: 1.1rem;
    }

    .event-type-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .event-type-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        width: 100%;
    }

    .event-type-btn:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(201, 100, 66, 0.1);
    }

    .event-type-btn.active {
        background: var(--primary-color);
        color: var(--primary-text);
        border-color: var(--primary-color);
    }

    .event-icon {
        font-size: 1.2rem;
    }

    .event-name {
        font-weight: 500;
    }

    .event-content {
        flex: 1;
        min-width: 0;
    }

    .date-selector-container {
        margin-bottom: 1.5rem;
    }

    .date-selector-container label {
        font-weight: 600;
        color: var(--bg-primary-text);
        margin-right: 0.5rem;
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--bg-secondary-text);
    }

    .event-list-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        overflow: hidden;
    }

    .event-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-primary);
        background: var(--bg-primary);
    }

    .event-list-header h3 {
        margin: 0;
        color: var(--bg-primary-text);
        font-size: 1.2rem;
    }

    .pagination-info {
        color: var(--bg-secondary-text);
        font-size: 0.9rem;
    }

    .event-list {
        padding: 1.5rem;
        max-height: 500px;
        overflow-y: auto;
    }

    .event-item {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-secondary);
        gap: 1rem;
    }

    .event-item:last-child {
        border-bottom: none;
    }

    .event-rank {
        flex: 0 0 40px;
        text-align: center;
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    .event-details {
        flex: 1;
        min-width: 0;
    }

    .event-key {
        font-weight: 500;
        color: var(--bg-primary-text);
        margin-bottom: 0.25rem;
        word-break: break-all;
    }

    .event-count {
        font-size: 0.9rem;
        color: var(--bg-secondary-text);
    }

    .event-bar {
        flex: 0 0 100px;
        height: 8px;
        background: var(--border-secondary);
        border-radius: 4px;
        overflow: hidden;
    }

    .event-bar-fill {
        height: 100%;
        background: var(--primary-color);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid var(--border-primary);
        background: var(--bg-primary);
    }

    .pagination-btn {
        padding: 0.5rem 1rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        color: var(--bg-primary-text);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .pagination-btn:hover:not(:disabled) {
        background: var(--primary-color);
        color: var(--primary-text);
        border-color: var(--primary-color);
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-current {
        font-weight: 600;
        color: var(--primary-color);
        padding: 0.5rem 1rem;
    }

    .date-selector {
        padding: 0.5rem;
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        background: var(--bg-primary);
        color: var(--bg-primary-text);
    }

    .date-selector:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(201, 100, 66, 0.1);
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .detail-container {
            flex-direction: column;
            gap: 1rem;
        }

        .event-sidebar {
            flex: none;
            width: 100%;
        }

        .stats-summary {
            grid-template-columns: 1fr;
        }

        .event-list-header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .event-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .event-bar {
            flex: none;
            width: 100%;
        }
    }
</style>
{{end}}